# 塔罗记录业务流程文档

## 概述
塔罗记录功能是月相成长计划器的核心功能之一，用于记录和管理用户的塔罗占卜体验。该功能与月相周期深度集成，提供基于月相的占卜指导和记录管理。

## 1. 触发新建塔罗记录

### 1.1 用户入口
- **主页面触发**：用户在主页面点击"塔罗记录"按钮
- **组件位置**：`src/pages/Index.tsx` 中的操作按钮栏
- **触发事件**：`onClick={() => setTarotModalOpen(true)}`

### 1.2 状态管理
- **模态框状态**：`tarotModalOpen` 控制 `TarotModal` 的显示/隐藏
- **当前月相**：通过 `useMoonPhase` 钩子获取当前月相数据
- **项目列表**：通过 `useProjects` 钩子获取可关联的项目列表

## 2. 月相数据获取

### 2.1 月相计算
- **服务文件**：`src/hooks/useMoonPhase.ts`
- **计算方式**：基于固定参考点（2024-01-11）和29.5天周期进行简化计算
- **更新频率**：每分钟自动更新一次

### 2.2 月相类型识别
```typescript
const MOON_PHASES = {
  NEW_MOON: { name: '新月', emoji: '🌑' },
  WAXING_CRESCENT: { name: '峨眉月', emoji: '🌒' },
  FIRST_QUARTER: { name: '上弦月', emoji: '🌓' },
  WAXING_GIBBOUS: { name: '盈凸月', emoji: '🌔' },
  FULL_MOON: { name: '满月', emoji: '🌕' },
  WANING_GIBBOUS: { name: '亏凸月', emoji: '🌖' },
  LAST_QUARTER: { name: '下弦月', emoji: '🌗' },
  WANING_CRESCENT: { name: '残月', emoji: '🌘' }
}
```

### 2.3 月相指导信息
- **新月**：适合询问新开始和设定意图的问题
- **满月**：适合询问完成、收获和反思的问题
- **上弦月**：适合询问行动和克服挑战的问题
- **下弦月**：适合询问释放和清理的问题

## 3. 塔罗记录表单界面

### 3.1 界面组件
- **组件文件**：`src/components/TarotModal.tsx`
- **UI框架**：基于shadcn/ui组件库
- **设计风格**：深紫色主题，符合神秘学美学

### 3.2 表单字段

#### 3.2.1 当前月相显示
- **显示内容**：月相名称、emoji、光照度
- **指导建议**：根据月相类型显示相应的占卜建议
- **样式**：紫色渐变背景，居中显示

#### 3.2.2 占卜问题输入
- **字段类型**：多行文本域（Textarea）
- **验证规则**：必填字段，不能为空
- **最小高度**：80px，3行
- **占位符**：输入你想要占卜的问题...

#### 3.2.3 塔罗牌选择
- **选择方式**：
  - 手动输入：用户输入牌名，按Enter或点击+按钮添加
  - 快速选择：从22张主要阿卡那中快速选择
- **常用塔罗牌**：
  ```typescript
  const commonTarotCards = [
    '愚者', '魔术师', '女祭司', '皇后', '皇帝', '教皇', '恋人', '战车',
    '力量', '隐者', '命运之轮', '正义', '倒吊人', '死神', '节制', '恶魔',
    '塔', '星星', '月亮', '太阳', '审判', '世界'
  ];
  ```
- **交互功能**：
  - 支持添加多张牌
  - 支持删除已选择的牌
  - 防重复选择
  - 以徽章形式展示已选牌

#### 3.2.4 牌面解读
- **字段类型**：多行文本域
- **最小高度**：120px，5行
- **占位符**：记录你对这次占卜的解读和感受...
- **用途**：记录用户的个人解读和感受

#### 3.2.5 项目关联
- **字段类型**：下拉选择器（Select）
- **选项来源**：从 `useProjects` 钩子获取项目列表
- **可选性**：非必填字段，支持"不关联项目"选项

## 4. 数据处理与验证

### 4.1 表单验证
- **必填字段验证**：
  - 占卜问题不能为空
  - 至少选择一张塔罗牌
- **提交按钮状态**：验证失败时禁用提交按钮

### 4.2 数据结构
```typescript
interface TarotRecord {
  id: string;
  date: Date;
  moonPhase: string;
  question: string;
  cards: string[];
  interpretation: string;
  projectId?: string;
}
```

### 4.3 数据处理流程
1. **表单提交**：`handleSubmit` 函数处理表单提交
2. **数据组装**：将表单数据组装成 `TarotRecord` 对象
3. **ID生成**：使用时间戳生成唯一ID
4. **状态更新**：调用 `addTarotRecord` 更新本地状态
5. **持久化**：数据保存到 localStorage
6. **界面重置**：清空表单并关闭模态框

## 5. 数据存储与管理

### 5.1 存储方式
- **存储位置**：浏览器 localStorage
- **存储键名**：`tarotRecords`
- **数据格式**：JSON字符串

### 5.2 数据管理钩子
- **钩子文件**：`src/hooks/useTarotRecords.ts`
- **主要功能**：
  - `addTarotRecord`: 添加新记录
  - `updateTarotRecord`: 更新现有记录
  - `deleteTarotRecord`: 删除记录
  - `tarotRecords`: 获取所有记录

### 5.3 初始化数据
系统会在首次使用时创建示例数据：
```typescript
const sampleRecords: TarotRecord[] = [
  {
    id: 'tarot-1',
    date: new Date('2024-01-11'),
    moonPhase: '新月',
    question: '我在学习塔罗的道路上应该注意什么？',
    cards: ['愚者', '魔术师', '女祭司'],
    interpretation: '愚者代表新的开始，魔术师象征着你拥有实现目标的所有工具，女祭司提醒你要相信内在的直觉。这个组合表明你正处于学习的最佳时机。',
    projectId: '1'
  }
  // ... 更多示例数据
];
```

## 6. 记录展示与预览

### 6.1 预览组件
- **组件文件**：`src/components/TarotRecordPreview.tsx`
- **显示位置**：主页面右侧栏
- **显示数量**：最近5条记录

### 6.2 记录卡片设计
- **卡片信息**：
  - 占卜日期和时间
  - 月相信息和emoji
  - 占卜问题
  - 选择的塔罗牌（徽章形式）
  - 解读内容预览（2行截断）
- **交互功能**：
  - 鼠标悬停显示完整内容
  - 点击可能触发编辑功能

### 6.3 空状态处理
当没有记录时显示：
- 占卜图标
- 提示文本：还没有塔罗记录
- 引导文本：点击"塔罗记录"开始你的占卜之旅

## 7. 业务流程总结

### 7.1 完整流程
1. **用户触发** → 点击"塔罗记录"按钮
2. **月相获取** → 系统自动获取当前月相信息
3. **界面展示** → 显示塔罗记录模态框
4. **表单填写** → 用户填写占卜问题、选择塔罗牌、输入解读
5. **数据验证** → 系统验证必填字段
6. **数据保存** → 记录保存到localStorage
7. **界面更新** → 更新预览区域显示
8. **模态框关闭** → 重置表单并关闭界面

### 7.2 关键特性
- **月相集成**：与月相周期深度集成，提供相应指导
- **直观操作**：支持手动输入和快速选择两种方式
- **项目关联**：可选择关联到具体项目
- **数据持久化**：本地存储确保数据不丢失
- **实时预览**：主页面实时显示最新记录

### 7.3 扩展性考虑
- **云端同步**：未来可扩展支持云端存储
- **更多牌组**：支持其他塔罗牌组和占卜系统
- **高级分析**：基于历史记录的趋势分析
- **社区功能**：分享和交流占卜经验

## 8. 技术实现细节

### 8.1 技术栈
- **前端框架**：React + TypeScript
- **UI组件**：shadcn/ui
- **状态管理**：React Hooks
- **数据存储**：localStorage
- **日期处理**：date-fns

### 8.2 核心文件结构
```
src/
├── components/
│   ├── TarotModal.tsx          # 塔罗记录模态框
│   └── TarotRecordPreview.tsx  # 记录预览组件
├── hooks/
│   ├── useTarotRecords.ts      # 塔罗记录管理
│   └── useMoonPhase.ts         # 月相数据管理
├── lib/
│   └── types.ts                # 类型定义
└── pages/
    └── Index.tsx               # 主页面
```

### 8.3 性能优化
- **按需加载**：预览组件只加载最近5条记录
- **状态缓存**：使用React状态缓存减少重复计算
- **防抖处理**：月相数据每分钟更新一次 